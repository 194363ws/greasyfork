<p>
	<%=t('scripts.rules_summary_html', {:full_rules_link => link_to(t('scripts.rules_summary_link_to_full'), help_code_rules_path)})%>
</p>

<% # ignore userscripts.org sync
if !script_version.script.script_sync_type_id.nil? and script_version.script.script_sync_source_id != 2 %>
	<p>
		<%=t('scripts.syncing_notice_html', {
			:syncing_notice_sync_type => link_to(
				t(
					script_version.script.script_sync_type_id == 1 ? 'scripts.syncing_notice_sync_type_manual' : 'scripts.syncing_notice_sync_type_automatic',
					{:sync_identifier => script_version.script.sync_identifier}
				),
				script_sync_path(script_version.script_id)
			)
		})%>
	</p>
<% end %>

<%=form_for(script_version.script.new_record? ? script_version : [script_version.script, script_version], {:html => {:enctype => 'multipart/form-data'}}) do |s| %>

	<% # remember previously chosen overrides
	[:accepted_assessment, :version_check_override, :add_missing_version, :namespace_check_override, :add_missing_namespace, :minified_confirmation].each do |override|
		if script_version.send(override) %>
			<%=s.hidden_field(override)%>
		<% end
	end

	if !script_version.errors.empty? or !script_version.script.errors.empty? %>
		<div class="alert">
			<p><%=t('common.error_preamble')%></p>
			<ul class="errors">
				<% script_version.errors.each do |attr, msg|
					# need custom handling for warnings
					next if msg.starts_with?('warning-') %>
					<li><%=attr == :base ? msg : script_version.errors.generate_message(attr, msg)%></li>
				<% end
				script_version.script.errors.full_messages.each do |m| %>
					<li><%=m%></li>
				<% end
				script_version.warnings.each do |w| %>
					<li><%
						case w
							when :uses_disallowed_requires %>
								<%=t('scripts.warning_uses_disallowed_requires_html', {
									:requires_used => script_version.disallowed_requires_used.join(', '),
									:external_script_rules_link => link_to(t('scripts.warning_uses_disallowed_requires_rules_link'), help_external_scripts_path(), {:target => 'code_rules'})
								})%><br>
								<label for="script_version_accepted_assessment"><%=t('scripts.override_warning_checkbox_label')%></label> <%=s.check_box(:accepted_assessment, {}, true, false)%>
							<% when :version_not_incremented %>
								<%=t('scripts.warning_version_not_incremented_html')%><br>
								<label for="script_version_version_check_override"><%=t('scripts.override_warning_checkbox_label')%></label> <%=s.check_box(:version_check_override, {}, true, false)%>
							<% when :version_missing %>
								<%=t('scripts.warning_version_missing_html')%><br>
								<label for="script_version_add_missing_version"><%=t('scripts.warning_version_missing_generate_automatically_html')%></label> <%=s.check_box(:add_missing_version, {}, true, false)%>
							<% when :namespace_missing %>
								<%=t('scripts.warning_namespace_missing_html')%><br>
								<label for="script_version_add_missing_namespace"><%=t('scripts.warning_namespace_missing_generate_automatically')%></label> <%=s.check_box(:add_missing_namespace, {}, true, false)%>
							<% when :namespace_changed %>
								<%=t('scripts.warning_namespace_changed_html')%><br>
								<label for="script_version_namespace_check_override"><%=t('scripts.override_warning_checkbox_label')%></label> <%=s.check_box(:namespace_check_override, {}, true, false)%>
							<% when :potentially_minified %>
								<%=t('scripts.warning_potentially_minified_html', {:allowed_requires_link => link_to(t('scripts.warning_potentially_minified_allowed_requires_link'), help_external_scripts_path())})%><br>
								<label for="script_version_minified_confirmation"><%=t('scripts.override_warning_checkbox_label')%></label> <%=s.check_box(:minified_confirmation, {}, true, false)%>
							<% else
								raise "Unknown warning #{w}"
						end %>
					</li><%
				end %>
			</ul>
		</div>
	<% end %>

	<% if @script.library? %>
		<div class="form-control">
			<label for="library-name"><%=t('activerecord.attributes.script.name')%></label><br>
			<input id="library-name" name="name" value="<%=@script.name%>" maxlength="100">
		</div>
		<div class="form-control">
			<label for="library-description"><%=t('activerecord.attributes.script.description')%></label><br>
			<input id="library-description" name="description" value="<%=@script.description%>" maxlength="500">
		</div>
	<% end %>
	<div class="form-control">
		<label for="code"><%=t('activerecord.attributes.script.code')%></label><br>
		<%=s.text_area(:code)%>
		<div><%=t('scripts.upload_label')%> <input type="file" name="code_upload" id="code-upload" accept="text/javascript,application/javascript"></div>
	</div>
	<% if !script_version.script.new_record? %>
		<div class="form-control">
			<label for="changelog"><%=t('activerecord.attributes.script.changelog')%></label> <span class="label-note"><%=t('scripts.changelog_note')%></span><br>
			<%=s.text_field(:changelog, :maxlength => 500, :size => nil)%>
		</div>
	<% end %>
	<div class="form-control radio-group">
		<label><%=t('activerecord.attributes.script.type')%></label><br>
		<% ScriptType.all.each do |st| %>
			<%=radio_button('script', 'script_type_id', st.id)%> <label class="radio-label" for="script_script_type_id_<%=st.id%>"><%=t("scripts.type_#{st.id}_html")%></label><br>
		<% end %>
	</div>
	<div class="form-control radio-group">
		<label><%=t('activerecord.attributes.script.locale')%></label> <span class="label-note"><%=t('scripts.locale_explanation')%></span><br>
		<select name="script[locale_id]">
			<option value="" <%if @script.locale_id.nil?%>selected<%end%>><%=t('scripts.locale_auto_select')%></option>
			<option disabled>---</option>
			<% Locale.where(:ui_available => true).each do |locale| %>
				<option value="<%=locale.id%>" <%if @script.locale_id == locale.id%>selected<%end%>><%=locale.display_text%></option>
			<% end %>
			<option disabled>---</option>
			<% Locale.all.each do |locale| %>
				<option value="<%=locale.id%>"<%if @script.locale_id == locale.id%>selected<%end%>><%=locale.display_text%></option>
			<% end %>
		</select>
	</div>
	<div class="form-control">
		<label for="additional-info"><%=t('activerecord.attributes.script.additional_info')%></label>
		<span class="label-note">
			<%=t('scripts.additional_info_note_html', {:allowed_elements_link => link_to( t('common.allowed_elements_link'), help_allowed_markup_path, {:target => 'markup_choice'})})%>
			<%=s.radio_button(:additional_info_markup, 'html')%>HTML
			<%=s.radio_button(:additional_info_markup, 'markdown')%><%=link_to 'Markdown', 'http://daringfireball.net/projects/markdown/basics', {:target => 'markup_choice'}%>
			<button name="preview" id="preview-script-additional-info" class="preview-button"><%=t('scripts.preview_additional_info')%></button>
		</span><br>
		<%=s.text_area(:additional_info, {:class => 'previewable', 'data-preview-activate-id' => 'preview-script-additional-info', 'data-markup-option-name' => 'script_version[additional_info_markup]', 'data-preview-result-id' => 'preview-script-additional-info-results'})%>
		<div id="preview-script-additional-info-results" class="preview-result" <%if !@preview.nil?%>style="display:block"<%end%>>
			<%if !@preview.nil?%><%=@preview.html_safe%><%end%>
		</div>
	</div>
	<%=s.submit(script_version.script.new_record? ? t('scripts.post_new_script') : t('scripts.post_updated_script'))%>
<% end %>
